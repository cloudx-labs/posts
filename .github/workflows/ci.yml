name: ci
on:
  pull_request:
    branches:
      - main

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      theirs: ${{ steps.changes.outputs.theirs }}
      others: ${{ steps.changes.outputs.others }}
    steps:
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            theirs:
              - 'posts/${{ github.event.pull_request.user.login }}/**'
            others:
              - 'posts/!(${{ github.event.pull_request.user.login }}/**)/**'
  lint:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.theirs == 'true'
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 17
      - run: npm ci
      - run: npx --no-install markdownlint **/*.md'
        working-directory: posts/${{ github.event.pull_request.user.login }}
  scope:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.others == 'true'
    steps:
      - name: Checking out of scope changes
        uses: actions/github-script@v3
        with:
          script: |
            core.setFailed("There are changes outside of the user's scope!")
  dry-run:
    runs-on: ubuntu-latest
    if: needs.changes.outputs.theirs == 'true'
    steps:
      - name: Dry-run on dev.to for ${{ github.event.pull_request.user.login }}
        uses: cloudx-labs/publish-devto@v3
        with:
          devto_key: ${{ secrets[format('devto_key_{0}', github.event.pull_request.user.login)] }}
          github_token: ${{ secrets.CI_PAT_TOKEN }}
          files: 'posts/${{ github.event.pull_request.user.login }}/**/*.md'
          # (Optional) The git branch to use. Default is 'main'.
          branch: main
          # (Optional) Use conventional commit messages. Default is false.
          # See https://www.conventionalcommits.org.
          conventional_commits: true
          dry_run: true
